# 第十一章 外部查找与排序
若数据存放在外存储器，如磁盘、磁带上，情况完全不同的排序和查找
由于磁盘和磁带访问是机械的，相当于百万千万条指令，所以宁愿做很多计算来避免一次外存访问
—— 包含外存操作时，外存访问次数决定操作运行时间
## 11.1 主储存器与外存储器

## 11.2+11.3 外部查找
查找是和数据在存储器上的储存方式有关的。内存的二叉树储存在这里会需多次访问磁盘，尤其最坏情况不适用。
为了使查找效率提高，需要用合适的记录组织方式将数据组织起来，减少磁盘访问次数。
磁盘访问次数——查找树高度——树的分支提高可以降低查找树高度
## 11.2 B树
### 11.2.1 B树的定义
**概念**：B数是一棵M叉的查找树
**定义**：一棵m阶B数要么为空，or满足以下条件：（防止退化成线性表）
- 根结点要么是叶子，要么至少两个儿子，至多m个儿子
- 除根结点和叶子节点外，每个结点的儿子个数s满足m/2上界 <= s <= m
- 有s个儿子的非叶节点具有n=s-1个关键值，故s=n+1，这些节点的数据信息为
  (n, A0, (K1, R1), A1, (K2, R2), A2, ..., (Kn, Rn), An)——n为关键字个数
- 所有叶节点出现在同一层，且深度相同，不带信息（外部结点/查找失败的结点。这些节点并不存在，指向这些节点的指针为空。）
（每个关键字都是有对应记录的）

### 11.2.2 B树的查找
查找根节点（找到，去R中找）—— 根据关键字值K到A指针指向的结点找（找到，去R处访问）
—— 根据关键字值K到A指针指向的结点找（找到，去R处访问）——到末尾找不到，查找失败。

### 11.2.3 B树的插入
以查找为基础，先通过查找操作确定插入位置（最底层的某个节点）
1. 若被插入结点关键字个数小于m-1，插入操作结束
2. 原有关键字个数以为m-1，必须分裂成两个结点（以下[]都是上界）
   - 结点1：1~[m/2]上界，共[m/2]-1个关键值
   - 结点2：上界[m/2]+1~m，共m-[m/2]>=[m/2]-1个关键值
   - 关键字K[m/2]和记录地址R[m/2]按序插入父结点相应位置。
3. 新关键字插入在2中导致父结点关键字个数增加一个，相当于父结点插入，若其原m-1关键字——新一轮节点分裂和父结点插入
   该过程不断进行可能一直到根结点。在跟节点上，根节点的分裂会导致新的根节点的创建，导致B树增高一层。

### 11.2.4 B树的删除
（类似于二叉树使用了替身的方法保证树的完整性）
删除与给定关键字值相等的关键字K的情况：
1. 待删关键字在最底层，直接删除
2. 不在底层，找替身，用待删值得“右子树”的最左面的结点的关键字值，即处于底层的最小关键字值替代。即转换为删除底层的该关键字。
具体删除最底层关键字的方法：
1. 删除后，节点关键字个数仍处于[m/2]-1和m-1之间，仍满足B树结点的定义，直接删除，＆结束。
2. 原[m/2]-1个关键字个数，直接删除则不符合B树定义。
   方法：找左/右兄弟“借”关键字
   左兄弟最大关键字上移，父结点最接近大于该值的关键字移入被删所在结点最左边（An也移入）
   右兄弟最小关键字上移，父结点最接近小于该值的关键字移入被删所在结点最右边（A0也移入）
3. 左右兄弟也[m/2]-1,无处可借，将其与左兄弟合并（若无左兄弟，则和右兄弟合并）
   父结点相应关键字不再保留，移入合并后的节点中。
   ——父结点关键字也少了一个，（不是相当于删除了一个，不是找替身），借?？，继续调整，可能波及根结点导致高度少1。

B树支持的是随机访问

## 11.3 B+树（最广泛应用的索引结构）
索引顺序文件：支持随机访问也支持按关键字次序访问得文件
可随机查找，可顺序访问的储存结构
### 11.3.1 B+树的定义
**概念**：B+数是满足某些平衡条件的M叉树
**定义**：M阶B+树是具有以下性质的M叉树：
- 所有数据记录被存储在叶子中，所有叶子连成一个单链表
h- 非叶节点至多保存M-1个键引导，键i表示子数i+1中键的最小值
- 根/叶子，或者有2~M个儿子
- 除根之外所有非叶节点儿子数 上界[M/2] ~ M 之间，保证B树不会退化成二叉树
- 叶结点中的孩子指针指向储存记录的数据块的地址。（B+的叶节点，数据块(磁盘块)的结父点）数据块是真正的叶节点。
  (B树结点保存指向记录的地址，叶结点的孩子指针是空指针。)
- 每个数据块至少[L/2]上界 个记录，至多L个记录。
ML是根据记录规模和关键字长度确定。（由于一个结点是一个磁盘块）

### 11.3.2 B+树的查找
查找某一条记录，从键值开始，根据键值决定寻找哪一棵子树。
逐层往下直到找到该记录存放的数据块。数据块中找，找到——查找成功，没找到——记录不存在。

### 11.3.3 B+树的插入
先从根结点开始查找**插入**的位置，再插入相应数据块中。
1. 最简单的情况：存放被插入记录的数据块还没放满。查找到数据块即可插入。
2. 较复杂情况：数据块一装满——分裂成两个（父结点关键字和分支改变）
   L+1个元素，分裂成两个数据块，（每个数据块都满足最小数据量要求），写回需要两次磁盘访问。
  父结点关键字和分支变化，更新需要一次磁盘访问。
  若父结点关键字已满：再分裂父亲(分裂后两个父亲关键字个数和不变，父亲多出一个孩子)——更新父亲和父亲的父亲的值——多出两次磁盘读写操作
  - 所以非叶子节点(?叶子不也会导致？)分裂，父亲多出一个孩子，其父亲孩子数量已满，继续向上分裂父亲直到不需要再分裂/到根结点
    到根节点，分裂根结点，作为创建的新根节点的两个儿子——————唯一一种使得B+树长高的情况。
其他解决方案：将孩子送往邻居寄养。

### 11.3.4 B+树的删除
先找到被删记录的结点，再从节点中删除它。
1. 结点记录不是最少——直接删除。
2. 结点记录最少，但邻居结点记录不是最少——领养一个孩子。
3. 结点记录最少，邻居结点记录也最少——合并。
   合并导致——父结点孩子数减少：根据父结点，邻居结点孩子情况选择直接删除、领养、合并
一直向根过滤，可能导致根只有一个孩子——删除根结点，其孩子作为根结点。——————唯一一种使B+树变矮的情况。

## 11.4 外排序

17.33/6/3